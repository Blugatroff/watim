extern "wasi_unstable" "fd_write" fn raw_write(file: i32, ptr: i32, len: i32, nwritten: i32) -> i32

fn write(file: i32, ptr: i32, len: i32) -> i32 {
    memory space 8 4;
    $space $ptr store32
    $space 4 + $len store32
    $file $space 1 $space raw_write
}

fn print_alphabet() {
    memory buf 27; // 26 letters + \n
    local i: i32
    loop {
        $i 26 = if { break }
        $i $buf + 97 $i + store8
        $i $buf + 1 + 10 store8

        1 $buf $i 2 + write drop
        
        $i 1 + #i
    }
}

fn print(n: i32) {
    memory buf 16;
    memory buf_reversed 16;
    local l: i32
    local i: i32
    1 100 7 write drop
    0 #l
    $n 0 = if {
        1 #l // length = 1
        $buf 48 store8 // put '0' in buf
    } else {
        loop {
            $n 0 = if { break }
            $buf $l +
            $n 10 % // rightmost digit
            48 + // + ascii '0'
            store8
            $n 10 / #n // shift right in decimal
            $l 1 + #l
        }
    }
    $l #i
    loop {
        $buf_reversed $l 1 - $i - + $buf $i + load32 store32
        $i 0 = if { break }
        $i 1 - #i
    }
    $buf_reversed $l + 10 store8 // add newline character
    1 $buf_reversed $l 1 + write drop
}

fn main "_start" () {
    print_alphabet
    10 print
    10 print
    10213 print
}
